---
import { getCollection } from 'astro:content';
import Layout from '../layouts/MinimalLayout.astro';

const allChains = await getCollection('chains');

// Helper to clean strings for URLs (e.g. "New York" -> "new-york")
const slugify = (str) => str.toLowerCase().replace(/ /g, '-').replace(/[^\w-]+/g, '');

// Structure: { "Canada": { "BC": Set("Vancouver") } }
const structure = {};

allChains.forEach((chain) => {
  const { country, region, city } = chain.data;
  if (!structure[country]) structure[country] = {};
  if (!structure[country][region]) structure[country][region] = new Set();
  structure[country][region].add(city);
});
---

<Layout title="Home">
  <div class="grid">
    {Object.keys(structure).sort().map((country) => (
      <div class="country-block">
        <h2>{country}</h2>
        {Object.keys(structure[country]).sort().map((region) => (
            <div class="region-block">
                <h3>{region}</h3>
                <div class="city-list">
                {Array.from(structure[country][region]).sort().map((city) => (
                    <a href={`/${slugify(country)}/${slugify(region)}/${slugify(city)}`} class="city-link">
                    {city}
                    </a>
                ))}
                </div>
            </div>
        ))}
      </div>
    ))}
  </div>
</Layout>

<style>
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 4rem; margin-top: 2rem; }
  h2 { border-bottom: 4px solid black; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
  h3 { font-size: 0.9rem; color: #888; margin-bottom: 0.5rem; margin-top: 1.5rem; }
  .city-link { display: block; font-size: 1.4rem; margin-bottom: 0.5rem; font-weight: bold; border-bottom: none; }
  .city-link:hover { text-decoration: underline; background: none; color: black; }
</style>
